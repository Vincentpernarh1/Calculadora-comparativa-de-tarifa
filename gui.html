<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculador de Tarifas Unificado</title>
    
    
  
    <script src="assets/tailwind.css"></script>
    
    <link rel="stylesheet" href="assets/choices.min.css">
    <script src="assets/choices.min.js"></script>

    
    <style>
        html, body { height: 100%; overflow: hidden; }
        body { display: flex; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px;}
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px;}
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px;}
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        #notification { transition: opacity 0.5s, transform 0.5s; transform: translateY(20px); max-width: 90%; }
        
        #results-container-wrapper { overflow: auto; }
        #results-table th { position: sticky; top: 0; background-color: #e5e7eb; z-index: 1; }
        #results-table td, #results-table th {
            user-select: text; /* or user-select: all; */
            cursor: text;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        select, input[type=number] {
            border-radius: 0.5rem;
        }

        /* Custom styles for Choices.js to match the UI */
        .choices { width: 100%; margin-bottom: 0; }
        .choices__inner {
            background-color: #fff;
            border-radius: 0.5rem;
            border: 1px solid rgb(209 213 219);
            padding: 0.45rem 0.75rem;
            font-size: 0.9rem;
            min-height: auto;
        }
        .is-open .choices__inner { border-radius: 0.5rem 0.5rem 0 0; }
        .choices__list--dropdown { border-radius: 0 0 0.5rem 0.5rem; }
        .choices[data-type*="select-one"]::after { right: 12.5px; }
        .choices.is-disabled .choices__inner, .choices.is-disabled .choices__input {
            background-color: #f3f4f6;
            cursor: not-allowed;
            -webkit-user-select: none;
            user-select: none;
        }

        option{
        font-size: 0.9rem;
        }
    </style>

</head>
<body class="bg-slate-100 font-sans">
    <div class="flex flex-col h-screen bg-white">
        <header class="sticky top-0 bg-indigo-900 shadow-md z-20 p-3">
            <div class="w-full px-6 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <button id="menu-toggle-btn" onclick="toggleSidebar()" class="text-white p-2 rounded-md hover:bg-indigo-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                        </svg>
                    </button>
                    <div>
                        <h1 class="text-xl font-bold text-white">Calculadora de Tarifas Por Fluxo</h1>
                        <p id="folder-path" class="text-xs text-indigo-300">Nenhuma pasta principal selecionada.</p>
                    </div>
                </div>
                <button onclick="selectBaseFolder()" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition flex-shrink-0">
                    Selecionar Pasta Principal
                </button>
            </div>
        </header>

        <main class="flex-grow overflow-auto p-6 w-full">
            <div class="flex flex-row gap-6 h-full">
                <div id="sidebar" class="lg:w-70 flex-shrink-0 bg-slate-50 p-3 rounded-lg shadow-sm flex flex-col gap-4 transition-all duration-300">
                    <div class="control-grid">
                        <div>
                            <label for="fluxo-select" class="block text-sm font-medium text-slate-700 mb-2">Escolher Fluxo</label>
                            <select id="fluxo-select" onchange="onFluxoSelected()" class="w-full p-1 bg-white border font-sm " disabled>
                                <option>Selecione uma pasta</option>
                            </select>
                        </div>

                        
                        <div>
                            <label for="nomeacao-select" class="block text-sm font-medium text-slate-700 mb-2">Nomeação</label>
                            <select id="nomeacao-select" class="w-full p-1 bg-white border font-sm text-sm" disabled>
                                <option>Selecione um fluxo</option>
                            </select>
                        </div>
                        <div>
                            <label for="fornecedor-select" class="block text-sm font-medium text-slate-700 mb-2">Fornecedor</label>
                            <select id="fornecedor-select" class="w-full p-1 bg-white border" disabled>
                                <option>Selecione um fluxo</option>
                            </select>
                        </div>
                        <div>
                            <label for="origem-select" class="block text-sm font-medium text-slate-700 mb-2">Origem</label>
                            <select id="origem-select" class="w-full p-1 bg-white border" disabled>
                                <option>Selecione um fluxo</option>
                            </select>
                        </div>
                        <div>
                            <label for="local-coleta-select" class="block text-sm font-medium text-slate-700 mb-2">Local de Coleta</label>
                            <select id="local-coleta-select" class="w-full p-1 bg-white border" disabled>
                                <option>Selecione um fluxo</option>
                            </select>
                        </div>
                        <div>
                            <label for="destino-select" class="block text-sm font-medium text-slate-700 mb-2">Destino</label>
                            <select id="destino-select" class="w-full p-1 bg-white border" disabled>
                                <option>Selecione um fluxo</option>
                            </select>
                        </div>
                        <div>
                            <label for="vehicle-select" class="block text-sm font-medium text-slate-700 mb-2">Tipo de Veículo</label>
                            <select id="vehicle-select" class="w-full p-1 bg-white border" disabled>
                                <option>Selecione um fluxo</option>
                            </select>
                        </div>

                        <div id="motorista-filter-div" class="hidden">
                            <label for="motorista-select" class="block text-sm font-medium text-slate-700 mb-2">Motorista(s)</label>
                            <select id="motorista-select" class="w-full p-1 bg-white border" disabled>
                                <option>Selecione as opções</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Viagem</label>
                            <div class="flex items-center justify-between bg-white border rounded-lg p-1">
                                <button id="calc-type-OW" onclick="setCalcType('OW')" class="w-1/2 py-2 text-sm font-semibold bg-indigo-600 text-white rounded-md">One Way (OW)</button>
                                <button id="calc-type-RT" onclick="setCalcType('RT')" class="w-1/2 py-2 text-sm font-semibold text-slate-600 rounded-md">Round Trip (RT)</button>
                            </div>
                        </div>
                        <div>
                            <label for="km-value" class="block text-sm font-medium text-slate-700 mb-2">Nova Distância (KM) (Opcional)</label>
                            <input type="number" id="km-value" placeholder="Para 'Regra de Três'" class="w-full p-1 bg-white border">
                        </div>
                    </div>
                    <div class="mt-auto pt-2">
                        <button onclick="performCalculation()" class="w-full bg-blue-600 text-white font-bold p-3 rounded-lg shadow-md hover:bg-blue-700">
                            Calcular Tarifas
                        </button>
                    </div>
                </div>

                <div class="flex-grow flex flex-col">
                    <div id="calc-placeholder" class="flex-grow h-full flex flex-col items-center justify-center text-center py-5 px-2 border-2 border-dashed border-slate-300 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-24 h-24 text-slate-300 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                           <path d="M14 17.5V19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h12v2.5"/>
                           <path d="M12 17.5h8.5l3-4.5-3-4.5H12Z"/><circle cx="6.5" cy="17.5" r="2.5"/><circle cx="18.5" cy="17.5" r="2.5"/>
                        </svg>
                        <p class="text-slate-500">Os resultados da cotação aparecerão aqui.</p>
                    </div>
                    <div id="calc-loading" class="flex-grow h-full hidden items-center justify-center text-center py-100"><p class="text-slate-600">Calculando...</p></div>
                    
                    <div id="results-table" class="hidden h-full flex flex-col">
                         <div class="flex justify-between items-center mb-1 flex-shrink-0">
                             <h2 class="text-xl font-bold text-slate-700">Resultados da Tarifas </h2>
                             <button id="export-btn" onclick="exportResults()" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700">
                                 Exportar para Excel
                             </button>
                         </div>
                         <div id="results-container-wrapper" class="border rounded-lg flex-grow">
                             <table class="min-w-full bg-white"><thead class="bg-slate-200" id="results-head"></thead><tbody id="results-body" class="divide-y divide-slate-200"></tbody></table>
                         </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="bg-white border-t p-2 z-10"><div class="w-full px-6 flex justify-between items-center"><p class="text-xs text-slate-400">Desenvolvido por Vincent Pernah - Analista de Projetos</p><div class="flex items-center gap-4"><span class="font-bold text-sm text-slate-700">Stellantis</span><span class="font-bold text-sm" style="color: #D40511;">DHL</span></div></div></footer>
    </div>

    <div id="notification" class="fixed bottom-12 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 pointer-events-none z-30"></div>

    
# !------------------------------ Java Script Contions and Code -----------------------------------------!
    <script>
        let currentCalcType = 'OW';
        let choiceInstances = {};

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
        }

        function destroyAllChoiceInstances() {
            for (const id in choiceInstances) {
                if (choiceInstances[id]) {
                    choiceInstances[id].destroy();
                    delete choiceInstances[id];
                }
            }
        }

        function initializeSearchableDropdown(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                const choices = new Choices(element, {
                    searchEnabled: true,
                    itemSelectText: '✔️',
                    noResultsText: 'Nenhum resultado',
                    noChoicesText: 'Sem opções'
                });
                choiceInstances[elementId] = choices;
            }
        }

        function setCalcType(type) {
            currentCalcType = type;
            const btnOW = document.getElementById('calc-type-OW');
            const btnRT = document.getElementById('calc-type-RT');
            
            if (type === 'OW') {
                btnOW.classList.add('bg-indigo-600', 'text-white');
                btnOW.classList.remove('text-slate-600');
                btnRT.classList.remove('bg-indigo-600', 'text-white');
                btnRT.classList.add('text-slate-600');
            } else { // RT
                btnRT.classList.add('bg-indigo-600', 'text-white');
                btnRT.classList.remove('text-slate-600');
                btnOW.classList.remove('bg-indigo-600', 'text-white');
                btnOW.classList.add('text-slate-600');
            }
        }

        async function selectBaseFolder() {
            try {
                const response = await window.pywebview.api.select_folder();
                if (response.success) {
                    document.getElementById('folder-path').textContent = `Pasta: ${response.path}`;
                    showNotification('Pasta principal selecionada!', true);
                    populateDropdown('fluxo-select', response.fluxos, 'Selecione um fluxo');
                    document.getElementById('fluxo-select').disabled = false;
                    resetAllFilters();
                } else {
                    showNotification(response.message, false);
                }
            } catch (e) {
                showNotification('Ocorreu um erro ao selecionar a pasta.', false);
            }
        }

        async function onFluxoSelected() {
            const fluxo = document.getElementById('fluxo-select').value;
            const motoristaFilterDiv = document.getElementById('motorista-filter-div');

            // Show/hide motorista filter based on fluxo
            if (fluxo && fluxo.toUpperCase().includes('SPOTS')) {
                motoristaFilterDiv.classList.remove('hidden');
            } else {
                motoristaFilterDiv.classList.add('hidden');
            }

            if (!fluxo) {
                resetAllFilters();
                return;
            }
            
            showLoadingOnFilters();

            try {
                const response = await window.pywebview.api.get_filters_for_fluxo(fluxo);
                if (response.success) {
                    populateDropdown('nomeacao-select', response.filters.Nomeacao, 'Todas');
                    populateDropdown('fornecedor-select', response.filters.Fornecedores, 'Todos');
                    populateDropdown('origem-select', response.filters.Origem, 'Todas');
                    populateDropdown('local-coleta-select', response.filters.LocaisColeta, 'Todos');
                    populateDropdown('destino-select', response.filters.Destino, 'Todos');
                    populateDropdown('vehicle-select', response.filters.Veiculos, 'Todos');
                    
                    // Populate motorista dropdown if it's a SPOTS flow
                    if (fluxo.toUpperCase().includes('SPOTS')) {
                        populateDropdown('motorista-select', response.filters.Motoristas, 'Todos');
                        initializeSearchableDropdown('motorista-select');
                    }

                    initializeSearchableDropdown('fornecedor-select');
                    initializeSearchableDropdown('origem-select');
                    initializeSearchableDropdown('local-coleta-select');
                    initializeSearchableDropdown('destino-select');
                    initializeSearchableDropdown('vehicle-select');

                    enableAllFilters();
                } else {
                    showNotification(response.message, false);
                    resetAllFilters();
                }
            } catch (e) {
                showNotification('Erro ao carregar filtros para este fluxo: ' + e, false);
                resetAllFilters();
            }
        }

        async function performCalculation() {
            const params = {
                fluxo: document.getElementById('fluxo-select').value,
                nomeacao: document.getElementById('nomeacao-select').value,
                fornecedor: document.getElementById('fornecedor-select').value,
                origem: document.getElementById('origem-select').value,
                local_coleta: document.getElementById('local-coleta-select').value,
                destino: document.getElementById('destino-select').value,
                veiculo: document.getElementById('vehicle-select').value,
                motorista: document.getElementById('motorista-select').value,
                calc_type: currentCalcType,
                km_value: document.getElementById('km-value').value
            };

            if (!params.fluxo) {
                showNotification('Por favor, selecione um fluxo.', false);
                return;
            }

            document.getElementById('calc-loading').style.display = 'flex';
            document.getElementById('calc-placeholder').style.display = 'none';
            document.getElementById('results-table').classList.add('hidden');
            
            try {
                const results = await window.pywebview.api.calculate_tariffs(params);
                displayCalcResults(results);
            } catch (e) {
                showNotification("Ocorreu um erro ao calcular.", false);
                console.error(e);
            } finally {
                document.getElementById('calc-loading').style.display = 'none';
            }
        }

        function displayCalcResults(results) {
            const head = document.getElementById('results-head');
            const body = document.getElementById('results-body');
            const resultsTable = document.getElementById('results-table');
            const placeholder = document.getElementById('calc-placeholder');
            
            head.innerHTML = '';
            body.innerHTML = '';

            if (!results || results.length === 0) {
                placeholder.style.display = 'flex';
                placeholder.innerHTML = `<p class="text-orange-600">Nenhum resultado encontrado para os critérios selecionados.</p>`;
                resultsTable.classList.add('hidden');
                return;
            }

            const headers = Object.keys(results[0]);
            const headerRow = document.createElement('tr');
            headers.forEach(h => {
                const th = document.createElement('th');
                th.className = 'text-left text-sm font-bold py-3 px-4 whitespace-nowrap';
                th.textContent = h;
                headerRow.appendChild(th);
            });
            head.appendChild(headerRow);

            results.forEach(result => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50 fade-in';
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.className = 'py-2 px-4 text-sm';
                    
                    if (header === 'Tarifa' && typeof result[header] === 'number') {
                        td.textContent = result[header].toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    } else {
                        td.textContent = result[header];
                    }
                    row.appendChild(td);
                });
                body.appendChild(row);
            });
            
            resultsTable.classList.remove('hidden');
            placeholder.style.display = 'none';
        }

        async function exportResults() {
            try {
                showNotification('Abrindo diálogo para salvar...', true);
                const response = await window.pywebview.api.export_to_excel();
                if (response.message !== 'Exportação cancelada.') {
                    showNotification(response.message, response.success);
                }
            } catch (e) {
                showNotification('Falha ao exportar.', false);
            }
        }
        
        function populateDropdown(id, items, defaultText) {
            const select = document.getElementById(id);
            select.innerHTML = `<option value="">${defaultText}</option>`;
            (items || []).forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                select.appendChild(option);
            });
        }
        
        function resetAllFilters() {
            destroyAllChoiceInstances();
            ['nomeacao-select', 'fornecedor-select', 'origem-select', 'local-coleta-select', 'destino-select', 'vehicle-select', 'motorista-select'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option>Selecione um fluxo</option>';
                    select.disabled = true;
                }
            });
            document.getElementById('motorista-filter-div').classList.add('hidden');
        }

        function showLoadingOnFilters() {
            destroyAllChoiceInstances();
             ['nomeacao-select', 'fornecedor-select', 'origem-select', 'local-coleta-select', 'destino-select', 'vehicle-select', 'motorista-select'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option>Carregando...</option>';
                    select.disabled = true;
                }
            });
        }
        
        function enableAllFilters() {
             const filterIds = ['nomeacao-select', 'fornecedor-select', 'origem-select', 'local-coleta-select', 'destino-select', 'vehicle-select', 'motorista-select'];
             filterIds.forEach(id => {
                 const instance = choiceInstances[id];
                 if (instance) {
                        instance.enable();
                 } else {
                        const element = document.getElementById(id);
                        if (element) {
                            element.disabled = false;
                        }
                 }
            });
        }

        function showNotification(message, isSuccess) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `fixed bottom-12 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 pointer-events-none z-30 ${isSuccess ? 'bg-green-600' : 'bg-red-600'}`;
            notification.classList.remove('opacity-0');
            notification.style.transform = 'translateY(0)';
            setTimeout(() => {
                notification.classList.add('opacity-0');
                notification.style.transform = 'translateY(20px)';
            }, 5000);
        }
    </script>
</body>
</html>
